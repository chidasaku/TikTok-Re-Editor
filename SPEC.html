<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TikTok Re-Editor v3 技術仕様書</title>
    <!-- Updated: 2026-02-19 -->
    <style>
        :root {
            --primary: #00f2ea;
            --secondary: #fe2c55;
            --dark: #121212;
            --light: #ffffff;
            --gray: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            line-height: 1.8;
            color: var(--dark);
            background: #f5f5f5;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--light);
            padding: 60px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 3px solid var(--primary);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header .subtitle {
            font-size: 1.2em;
            color: #666;
        }

        .header .doc-meta {
            font-size: 0.9em;
            color: #999;
            margin-top: 10px;
        }

        h2 {
            font-size: 1.6em;
            color: var(--dark);
            margin: 50px 0 25px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 30px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        h3 {
            font-size: 1.3em;
            color: var(--gray);
            margin: 30px 0 15px 0;
        }

        h4 {
            font-size: 1.1em;
            color: #555;
            margin: 20px 0 10px 0;
        }

        p {
            margin: 15px 0;
            color: #444;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid var(--primary);
        }

        .feature-card h4 {
            color: var(--dark);
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .feature-card p {
            margin: 0;
            font-size: 0.95em;
            color: #666;
        }

        .feature-card ul {
            margin: 8px 0 0 0;
            padding-left: 18px;
            font-size: 0.9em;
            color: #666;
        }

        .feature-card li {
            margin: 4px 0;
        }

        .step-container {
            margin: 30px 0;
        }

        .step {
            display: flex;
            gap: 20px;
            margin: 25px 0;
            padding: 25px;
            background: #fafafa;
            border-radius: 15px;
            border: 1px solid #eee;
        }

        .step-number {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3em;
        }

        .step-content {
            flex: 1;
            overflow-wrap: break-word;
            word-break: break-all;
            min-width: 0;
        }

        .step-content h4 {
            margin: 0 0 10px 0;
            color: var(--dark);
        }

        .step-content ol, .step-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .step-content li {
            margin: 8px 0;
            color: #555;
        }

        .note {
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .note-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        .important {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--secondary);
        }

        .important-title {
            font-weight: bold;
            color: #721c24;
            margin-bottom: 10px;
        }

        .info-box {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }

        .info-box-title {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        th {
            background: linear-gradient(135deg, var(--dark), #2a2a2a);
            color: white;
            padding: 15px;
            text-align: left;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        tr:hover {
            background: #e9ecef;
        }

        code {
            background: #2d2d2d;
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 5px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .code-block .comment {
            color: #6a9955;
        }

        .code-block .keyword {
            color: #569cd6;
        }

        .code-block .string {
            color: #ce9178;
        }

        .troubleshoot {
            margin: 20px 0;
        }

        .troubleshoot-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #6c757d;
        }

        .troubleshoot-item h4 {
            color: var(--dark);
            margin: 0 0 10px 0;
        }

        .troubleshoot-item ul {
            margin: 0;
            padding-left: 20px;
        }

        .version-history {
            margin: 30px 0;
        }

        .version {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }

        .version h4 {
            color: var(--dark);
            margin: 0 0 10px 0;
        }

        .version ul {
            margin: 0;
            padding-left: 20px;
        }

        .arch-diagram {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
            line-height: 1.8;
            overflow-x: auto;
            white-space: pre;
        }

        .dir-tree {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
            line-height: 1.8;
            overflow-x: auto;
        }

        .dir-tree .folder {
            color: #dcdcaa;
        }

        .dir-tree .file {
            color: #9cdcfe;
        }

        .dir-tree .desc {
            color: #6a9955;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-required {
            background: var(--secondary);
            color: white;
        }

        .badge-optional {
            background: #6c757d;
            color: white;
        }

        .badge-api {
            background: var(--primary);
            color: var(--dark);
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid #eee;
            color: #999;
            font-size: 0.9em;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 30px;
            }
            .step {
                break-inside: avoid;
            }
            .feature-card {
                break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px;
            }
            .feature-grid {
                grid-template-columns: 1fr;
            }
            .step {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TikTok Re-Editor v3</h1>
            <p class="subtitle">Technical Specification</p>
            <p class="doc-meta">Version 3.2 | Last Updated: 2026-02-19</p>
        </div>

        <!-- ============================================ -->
        <!-- 1. アプリ概要 -->
        <!-- ============================================ -->
        <h2>1. アプリ概要</h2>

        <table>
            <tr>
                <th>項目</th>
                <th>内容</th>
            </tr>
            <tr>
                <td><strong>名称</strong></td>
                <td>TikTok Re-Editor v3</td>
            </tr>
            <tr>
                <td><strong>目的</strong></td>
                <td>テキスト・動画・音声から、透過背景の縦型動画（1080x1920）を自動生成するWebアプリケーション</td>
            </tr>
            <tr>
                <td><strong>フレームワーク</strong></td>
                <td>Streamlit (Python)</td>
            </tr>
            <tr>
                <td><strong>デプロイ</strong></td>
                <td>Streamlit Cloud / ローカル（Windows/macOS）</td>
            </tr>
            <tr>
                <td><strong>ライセンス</strong></td>
                <td>MIT License</td>
            </tr>
        </table>

        <h3>アーキテクチャ概要</h3>
        <div class="arch-diagram">User Input (Text / Video / Audio)
       |
       v
+------------------+     +-------------------+
|   Gladia API     |---->|  Gemini API       |
|  (文字起こし)      |     |  (テキスト整形)     |
+------------------+     +-------------------+
                                |
                                v
                    +------------------------+
                    |  VideoGeneratorFFmpeg   |
                    |  +---------+  +------+ |
                    |  | Pillow  |  |FFmpeg| |
                    |  | (画像)  |  |(動画) | |
                    |  +---------+  +------+ |
                    +------------------------+
                         |            |
                         v            v
                    MOV (透過)    MP4 (プレビュー)
                    ProRes 4444   H.264</div>

        <!-- ============================================ -->
        <!-- 2. 主要機能 -->
        <!-- ============================================ -->
        <h2>2. 主要機能</h2>

        <p>4つの入力モードから動画生成までのワークフローを提供する。</p>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>A. 動画から生成</h4>
                <p>動画ファイルをアップロードし、Gladia APIで文字起こし後、Gemini APIでテキスト整形。</p>
                <ul>
                    <li>対応形式: MP4, MOV, AVI, MKV, WebM</li>
                    <li>必要API: Gladia + Gemini</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>B. ファイルから生成</h4>
                <p>.txtファイルをアップロードし、改行ごとに句読点を自動付与して整形。</p>
                <ul>
                    <li>対応形式: TXT (UTF-8)</li>
                    <li>必要API: なし（ファイル名生成にGemini）</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>C. テキスト入力</h4>
                <p>テキストエリアに直接貼り付け。改行ごとに句読点を自動付与して整形。</p>
                <ul>
                    <li>入力: フリーテキスト</li>
                    <li>必要API: なし（ファイル名生成にGemini）</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>D. 音声アップロード</h4>
                <p>外部TTSで生成した音声をアップロードし、Gladiaで単語レベルのタイムスタンプを取得。音声と字幕がピッタリ同期。</p>
                <ul>
                    <li>対応形式: WAV, MP3, M4A, AAC, OGG</li>
                    <li>必要API: Gladia + Gemini</li>
                </ul>
            </div>
        </div>

        <h3>入力モード別処理フロー</h3>
        <table>
            <tr>
                <th>モード</th>
                <th>入力</th>
                <th>文字起こし</th>
                <th>テキスト整形</th>
                <th>音声同期方式</th>
            </tr>
            <tr>
                <td><strong>動画から生成</strong></td>
                <td>動画ファイル</td>
                <td>Gladia API</td>
                <td>Gemini API</td>
                <td>外部音声アップロード / VOICEVOX</td>
            </tr>
            <tr>
                <td><strong>ファイルから生成</strong></td>
                <td>.txtファイル</td>
                <td>不要</td>
                <td>句読点自動付与</td>
                <td>外部音声アップロード / VOICEVOX</td>
            </tr>
            <tr>
                <td><strong>テキスト入力</strong></td>
                <td>フリーテキスト</td>
                <td>不要</td>
                <td>句読点自動付与</td>
                <td>外部音声アップロード / VOICEVOX</td>
            </tr>
            <tr>
                <td><strong>音声アップロード</strong></td>
                <td>音声ファイル</td>
                <td>Gladia API（単語タイムスタンプ）</td>
                <td>Gemini API</td>
                <td>アップロード音声をそのまま使用（単語レベル同期）</td>
            </tr>
        </table>

        <!-- ============================================ -->
        <!-- 3. テキスト処理機能 -->
        <!-- ============================================ -->
        <h2>3. テキスト処理機能</h2>

        <h3>3.1 テキスト整形（Gemini API）</h3>
        <p>クラス: <code>GeminiFormatter.format_text()</code></p>
        <table>
            <tr>
                <th>制約</th>
                <th>仕様</th>
            </tr>
            <tr>
                <td>1行あたりの最大文字数</td>
                <td>14文字</td>
            </tr>
            <tr>
                <td>行末句読点</td>
                <td>全行が「。」または「、」で終了すること</td>
            </tr>
            <tr>
                <td>文中改行</td>
                <td>「、」を付与</td>
            </tr>
            <tr>
                <td>文末</td>
                <td>「。」を付与</td>
            </tr>
            <tr>
                <td>内容変更</td>
                <td>禁止（原文の意味を保持）</td>
            </tr>
        </table>

        <h3>3.2 ひらがな変換（Gemini API）</h3>
        <p>クラス: <code>GeminiFormatter.convert_to_hiragana()</code></p>
        <table>
            <tr>
                <th>入力種別</th>
                <th>変換ルール</th>
                <th>例</th>
            </tr>
            <tr>
                <td>漢字</td>
                <td>ひらがな読みに変換</td>
                <td>東京 → とうきょう</td>
            </tr>
            <tr>
                <td>カタカナ</td>
                <td>ひらがなに変換</td>
                <td>アプリ → あぷり</td>
            </tr>
            <tr>
                <td>数字</td>
                <td>日本語読みに変換</td>
                <td>2026 → にせんにじゅうろく</td>
            </tr>
            <tr>
                <td>アルファベット</td>
                <td>カタカナ読み → ひらがな</td>
                <td>TikTok → てぃっくとっく</td>
            </tr>
        </table>

        <div class="note">
            <div class="note-title">読点ルール</div>
            <ul>
                <li>1行につき読点（、）は最大1個</li>
                <li>8文字未満の行は読点不要</li>
                <li>原文の句読点は保持</li>
            </ul>
        </div>

        <h3>3.3 ニュアンス調整（Gemini API）</h3>
        <p>クラス: <code>GeminiFormatter.rephrase_text()</code></p>

        <table>
            <tr>
                <th>パラメータ</th>
                <th>値</th>
                <th>説明</th>
            </tr>
            <tr>
                <td rowspan="3"><strong>politeness</strong><br>(丁寧さ)</td>
                <td><code>casual</code></td>
                <td>タメ口、くだけた表現</td>
            </tr>
            <tr>
                <td><code>polite</code></td>
                <td>です・ます調</td>
            </tr>
            <tr>
                <td><code>formal</code></td>
                <td>敬語、ビジネス調</td>
            </tr>
            <tr>
                <td rowspan="3"><strong>emotion</strong><br>(感情)</td>
                <td><code>gentle</code></td>
                <td>柔らかい表現、共感的</td>
            </tr>
            <tr>
                <td><code>strong</code></td>
                <td>断定的、エネルギッシュ</td>
            </tr>
            <tr>
                <td><code>cool</code></td>
                <td>淡々と、客観的</td>
            </tr>
            <tr>
                <td rowspan="3"><strong>style</strong><br>(スタイル)</td>
                <td><code>explanatory</code></td>
                <td>論理的、順序立てて</td>
            </tr>
            <tr>
                <td><code>conversational</code></td>
                <td>語りかける、問いかける</td>
            </tr>
            <tr>
                <td><code>narrative</code></td>
                <td>ストーリー調、引き込む</td>
            </tr>
        </table>

        <h3>3.4 SNSメタデータ生成（Gemini API）</h3>
        <p>クラス: <code>GeminiFormatter.generate_metadata()</code></p>
        <p>以下を自動生成する:</p>
        <ul>
            <li><strong>タイトル案</strong>: 3案（「【見出し】本文」形式、各30字以内）</li>
            <li><strong>紹介文案</strong>: 3案（各100字前後）</li>
            <li><strong>ハッシュタグ</strong>: 5個</li>
        </ul>

        <h3>3.5 ファイル名生成（Gemini API）</h3>
        <p>クラス: <code>GeminiFormatter.generate_filename()</code></p>
        <table>
            <tr>
                <th>制約</th>
                <th>内容</th>
            </tr>
            <tr>
                <td>最大文字数</td>
                <td>20文字</td>
            </tr>
            <tr>
                <td>禁止文字</td>
                <td><code>/\:*?"&lt;&gt;|</code></td>
            </tr>
            <tr>
                <td>改行</td>
                <td>禁止</td>
            </tr>
            <tr>
                <td>拡張子</td>
                <td>含めない</td>
            </tr>
            <tr>
                <td>日本語</td>
                <td>使用可</td>
            </tr>
        </table>

        <!-- ============================================ -->
        <!-- 4. 動画生成仕様 -->
        <!-- ============================================ -->
        <h2>4. 動画生成仕様</h2>

        <h3>4.1 出力フォーマット</h3>
        <table>
            <tr>
                <th>項目</th>
                <th>透過動画 (MOV)</th>
                <th>プレビュー動画 (MP4)</th>
            </tr>
            <tr>
                <td><strong>コンテナ</strong></td>
                <td>MOV</td>
                <td>MP4</td>
            </tr>
            <tr>
                <td><strong>映像コーデック</strong></td>
                <td>ProRes 4444 (prores_ks)</td>
                <td>H.264 (libx264)</td>
            </tr>
            <tr>
                <td><strong>プロファイル</strong></td>
                <td>4444 (アルファチャンネル対応)</td>
                <td>-</td>
            </tr>
            <tr>
                <td><strong>ピクセルフォーマット</strong></td>
                <td>yuva444p10le (10bit + Alpha)</td>
                <td>yuv420p</td>
            </tr>
            <tr>
                <td><strong>音声コーデック</strong></td>
                <td>PCM 16bit LE (pcm_s16le)</td>
                <td>AAC 192kbps</td>
            </tr>
            <tr>
                <td><strong>解像度</strong></td>
                <td>1080 x 1920</td>
                <td>1080 x 1920</td>
            </tr>
            <tr>
                <td><strong>フレームレート</strong></td>
                <td>30fps</td>
                <td>30fps</td>
            </tr>
            <tr>
                <td><strong>アスペクト比</strong></td>
                <td>9:16（TikTok縦型）</td>
                <td>9:16（TikTok縦型）</td>
            </tr>
            <tr>
                <td><strong>CRF / Preset</strong></td>
                <td>-</td>
                <td>CRF 18 / fast</td>
            </tr>
        </table>

        <h3>4.2 FFmpegコマンド仕様</h3>

        <h4>セグメント生成（透過 MOV）</h4>
        <div class="code-block">ffmpeg -y -loop 1 -framerate 30 -t {duration} -i {image.png} -i {audio.wav} \
  -c:v prores_ks -profile:v 4444 -pix_fmt yuva444p10le \
  -c:a pcm_s16le -map 0:v:0 -map 1:a:0 -vsync cfr {output.mov}</div>

        <h4>セグメント生成（プレビュー MP4）</h4>
        <div class="code-block">ffmpeg -y -loop 1 -framerate 30 -t {duration} -i {image.png} -i {audio.wav} \
  -c:v libx264 -tune stillimage -c:a aac -b:a 192k \
  -pix_fmt yuv420p -map 0:v:0 -map 1:a:0 -vsync cfr {output.mp4}</div>

        <h4>セグメント結合</h4>
        <div class="code-block"><span class="comment"># MOV (透過)</span>
ffmpeg -y -f concat -safe 0 -i {list.txt} \
  -c:v prores_ks -profile:v 4444 -pix_fmt yuva444p10le \
  -c:a pcm_s16le -vsync cfr -af aresample=async=1 {output.mov}

<span class="comment"># MP4 (プレビュー)</span>
ffmpeg -y -f concat -safe 0 -i {list.txt} \
  -c:v libx264 -preset fast -crf 18 \
  -c:a aac -b:a 192k -vsync cfr -af aresample=async=1 {output.mp4}</div>

        <h3>4.3 縦書きテキスト描画仕様</h3>
        <p>クラス: <code>VideoGeneratorFFmpeg._create_text_image()</code></p>

        <table>
            <tr>
                <th>項目</th>
                <th>仕様</th>
            </tr>
            <tr>
                <td>描画方向</td>
                <td>縦書き（上→下）</td>
            </tr>
            <tr>
                <td>配置</td>
                <td>画面中央</td>
            </tr>
            <tr>
                <td>フォントサイズ</td>
                <td>100px（デフォルト）</td>
            </tr>
            <tr>
                <td>文字送り</td>
                <td>フォントサイズと同値（100px）</td>
            </tr>
            <tr>
                <td>白背景矩形</td>
                <td>Y=288, パディング60px</td>
            </tr>
            <tr>
                <td>テキストオフセット</td>
                <td>矩形から5px</td>
            </tr>
            <tr>
                <td>句読点</td>
                <td>描画から除外（、。，．）</td>
            </tr>
        </table>

        <h4>特殊文字処理</h4>
        <table>
            <tr>
                <th>分類</th>
                <th>処理</th>
                <th>対象文字</th>
            </tr>
            <tr>
                <td><strong>回転文字</strong></td>
                <td>90度回転して配置（+font_size/4 オフセット）</td>
                <td>ー 〜 ～ － - ― ‐ – — = ＝ + ＋ &lt; &gt; ＜ ＞</td>
            </tr>
            <tr>
                <td><strong>小文字</strong></td>
                <td>右寄せ（10-20px右）、上方向に10-20px重ね</td>
                <td>っ ぁ ぃ ぅ ぇ ぉ ゃ ゅ ょ ゎ ッ ァ ィ ゥ ェ ォ ャ ュ ョ ヮ ヶ ヵ</td>
            </tr>
            <tr>
                <td><strong>通常文字</strong></td>
                <td>中央揃え、フォントサイズ間隔で配置</td>
                <td>上記以外の全文字</td>
            </tr>
        </table>

        <h4>フォント優先順位</h4>
        <table>
            <tr>
                <th>優先度</th>
                <th>フォント</th>
                <th>パス</th>
            </tr>
            <tr>
                <td>1</td>
                <td>NotoSansJP-Bold (同梱)</td>
                <td><code>fonts/NotoSansJP-Bold.otf</code></td>
            </tr>
            <tr>
                <td>2</td>
                <td>ヒラギノ角ゴシック (macOS)</td>
                <td><code>/System/Library/Fonts/ヒラギノ角ゴ*.ttc</code></td>
            </tr>
            <tr>
                <td>3</td>
                <td>Noto Sans CJK (Linux)</td>
                <td><code>/usr/share/fonts/opentype/noto/</code></td>
            </tr>
            <tr>
                <td>4</td>
                <td>游ゴシック / メイリオ (Windows)</td>
                <td><code>C:/Windows/Fonts/</code></td>
            </tr>
            <tr>
                <td>5</td>
                <td>PIL デフォルトフォント</td>
                <td>（フォールバック）</td>
            </tr>
        </table>

        <h3>4.4 プレビュー表示</h3>
        <ul>
            <li><strong>チェッカーボード背景</strong>: 透過を可視化（20pxセルサイズ、グレー200/150）</li>
            <li><strong>iPhone 15風フレーム</strong>: Dynamic Island付きのデバイスモックアップでプレビュー</li>
        </ul>

        <!-- ============================================ -->
        <!-- 5. API連携 -->
        <!-- ============================================ -->
        <h2>5. API連携</h2>

        <h3>5.1 Gladia API</h3>
        <p>クラス: <code>GladiaAPI</code> (<code>utils/transcription.py</code>)</p>

        <table>
            <tr>
                <th>項目</th>
                <th>仕様</th>
            </tr>
            <tr>
                <td>ベースURL</td>
                <td><code>https://api.gladia.io/v2</code></td>
            </tr>
            <tr>
                <td>認証</td>
                <td>ヘッダー: <code>x-gladia-key</code></td>
            </tr>
            <tr>
                <td>無料枠</td>
                <td>10時間/月</td>
            </tr>
        </table>

        <h4>エンドポイント</h4>
        <table>
            <tr>
                <th>操作</th>
                <th>メソッド</th>
                <th>エンドポイント</th>
                <th>説明</th>
            </tr>
            <tr>
                <td>ファイルアップロード</td>
                <td>POST</td>
                <td><code>/upload</code></td>
                <td>音声/動画ファイルをアップロード。<code>audio_url</code>を返す</td>
            </tr>
            <tr>
                <td>文字起こし開始</td>
                <td>POST</td>
                <td><code>/pre-recorded</code></td>
                <td>文字起こしジョブを開始。<code>id</code>を返す</td>
            </tr>
            <tr>
                <td>結果取得</td>
                <td>GET</td>
                <td><code>/pre-recorded/{id}</code></td>
                <td>ポーリングで結果取得。3秒間隔、最大60回（180秒）</td>
            </tr>
        </table>

        <h4>レスポンス構造（タイムスタンプ付き）</h4>
        <div class="code-block">{
  "segments": [
    {
      "start": 0.0,      <span class="comment">// 開始時間（秒）</span>
      "end": 2.5,        <span class="comment">// 終了時間（秒）</span>
      "text": "こんにちは",
      "words": [
        {"word": "こんにちは", "start": 0.0, "end": 2.5}
      ]
    }
  ],
  "words": [
    {"word": "こんにちは", "start": 0.0, "end": 2.5}
  ]
}</div>

        <h3>5.2 Gemini API</h3>
        <p>クラス: <code>GeminiFormatter</code> (<code>utils/text_formatter.py</code>)</p>

        <table>
            <tr>
                <th>項目</th>
                <th>仕様</th>
            </tr>
            <tr>
                <td>SDK</td>
                <td><code>google-genai</code> (Python)</td>
            </tr>
            <tr>
                <td>無料枠</td>
                <td>無料</td>
            </tr>
        </table>

        <h4>使用モデル（優先順位）</h4>
        <table>
            <tr>
                <th>優先度</th>
                <th>モデル</th>
                <th>フォールバック条件</th>
            </tr>
            <tr>
                <td>1</td>
                <td><code>gemini-2.5-flash</code></td>
                <td>-</td>
            </tr>
            <tr>
                <td>2</td>
                <td><code>gemini-2.5-flash-lite</code></td>
                <td>429 (Rate Limit) / 404</td>
            </tr>
            <tr>
                <td>3</td>
                <td><code>gemini-2.5-pro</code></td>
                <td>429 (Rate Limit) / 404</td>
            </tr>
            <tr>
                <td>4</td>
                <td><code>gemini-2.0-flash</code></td>
                <td>429 (Rate Limit) / 404</td>
            </tr>
        </table>

        <h4>API使用箇所</h4>
        <table>
            <tr>
                <th>機能</th>
                <th>メソッド</th>
                <th>リトライ</th>
            </tr>
            <tr>
                <td>テキスト整形</td>
                <td><code>format_text()</code></td>
                <td>モデル順にリトライ</td>
            </tr>
            <tr>
                <td>ファイル名生成</td>
                <td><code>generate_filename()</code></td>
                <td>モデル順にリトライ</td>
            </tr>
            <tr>
                <td>SNSメタデータ生成</td>
                <td><code>generate_metadata()</code></td>
                <td>デフォルトモデルのみ</td>
            </tr>
            <tr>
                <td>ニュアンス調整</td>
                <td><code>rephrase_text()</code></td>
                <td>モデル順にリトライ</td>
            </tr>
            <tr>
                <td>ひらがな変換</td>
                <td><code>convert_to_hiragana()</code></td>
                <td>モデル順にリトライ</td>
            </tr>
        </table>

        <h3>5.3 VOICEVOX API</h3>
        <p>クラス: <code>VoiceVoxAPI</code> (<code>utils/voicevox.py</code>)</p>

        <table>
            <tr>
                <th>項目</th>
                <th>仕様</th>
            </tr>
            <tr>
                <td>ベースURL</td>
                <td><code>http://localhost:50021</code></td>
            </tr>
            <tr>
                <td>動作要件</td>
                <td>VOICEVOXアプリがローカルで起動中であること</td>
            </tr>
            <tr>
                <td>出力形式</td>
                <td>WAV (パラメータはVOICEVOX依存)</td>
            </tr>
        </table>

        <h4>エンドポイント</h4>
        <table>
            <tr>
                <th>操作</th>
                <th>メソッド</th>
                <th>エンドポイント</th>
                <th>説明</th>
            </tr>
            <tr>
                <td>話者一覧</td>
                <td>GET</td>
                <td><code>/speakers</code></td>
                <td>利用可能な話者とスタイルの一覧</td>
            </tr>
            <tr>
                <td>音声クエリ生成</td>
                <td>POST</td>
                <td><code>/audio_query?text=&amp;speaker=</code></td>
                <td>テキストから音声合成パラメータを生成</td>
            </tr>
            <tr>
                <td>音声合成</td>
                <td>POST</td>
                <td><code>/synthesis?speaker=</code></td>
                <td>音声クエリからWAV音声を合成</td>
            </tr>
        </table>

        <h4>音声パラメータ</h4>
        <table>
            <tr>
                <th>パラメータ</th>
                <th>デフォルト値</th>
                <th>説明</th>
            </tr>
            <tr>
                <td><code>speedScale</code></td>
                <td>1.2</td>
                <td>話速（1.0 = 標準、1.2 = 20%速い）</td>
            </tr>
            <tr>
                <td><code>pauseLengthScale</code></td>
                <td>1.0</td>
                <td>ポーズ長さ（0.0〜2.0）</td>
            </tr>
            <tr>
                <td><code>outputStereo</code></td>
                <td>true</td>
                <td>ステレオ出力</td>
            </tr>
        </table>

        <h3>5.4 Lark Base API</h3>
        <p>クラス: <code>LarkBaseClient</code> (<code>auth/lark_base.py</code>)</p>

        <table>
            <tr>
                <th>項目</th>
                <th>仕様</th>
            </tr>
            <tr>
                <td>ベースURL</td>
                <td><code>https://open.larksuite.com/open-apis</code></td>
            </tr>
            <tr>
                <td>認証</td>
                <td>Tenant Access Token（2時間有効、5分前に自動更新）</td>
            </tr>
            <tr>
                <td>用途</td>
                <td>ユーザー管理データベース</td>
            </tr>
        </table>

        <h4>エンドポイント</h4>
        <table>
            <tr>
                <th>操作</th>
                <th>メソッド</th>
                <th>エンドポイント</th>
            </tr>
            <tr>
                <td>トークン取得</td>
                <td>POST</td>
                <td><code>/auth/v3/tenant_access_token/internal</code></td>
            </tr>
            <tr>
                <td>レコード検索</td>
                <td>POST</td>
                <td><code>/bitable/v1/apps/{token}/tables/{id}/records/search</code></td>
            </tr>
            <tr>
                <td>レコード作成</td>
                <td>POST</td>
                <td><code>/bitable/v1/apps/{token}/tables/{id}/records</code></td>
            </tr>
            <tr>
                <td>レコード更新</td>
                <td>PUT</td>
                <td><code>/bitable/v1/apps/{token}/tables/{id}/records/{id}</code></td>
            </tr>
            <tr>
                <td>レコード削除</td>
                <td>DELETE</td>
                <td><code>/bitable/v1/apps/{token}/tables/{id}/records/{id}</code></td>
            </tr>
            <tr>
                <td>全レコード取得</td>
                <td>POST</td>
                <td><code>/bitable/v1/apps/{token}/tables/{id}/records/search</code> (pagination)</td>
            </tr>
        </table>

        <!-- ============================================ -->
        <!-- 6. 認証・ユーザー管理 -->
        <!-- ============================================ -->
        <h2>6. 認証・ユーザー管理</h2>

        <h3>6.1 Google OAuth認証</h3>
        <p>Streamlit組み込みの<code>st.login()</code>/<code>st.logout()</code>を使用。</p>
        <table>
            <tr>
                <th>プロパティ</th>
                <th>型</th>
                <th>説明</th>
            </tr>
            <tr>
                <td><code>st.user.is_logged_in</code></td>
                <td>bool</td>
                <td>ログイン状態</td>
            </tr>
            <tr>
                <td><code>st.user.email</code></td>
                <td>str</td>
                <td>Googleメールアドレス</td>
            </tr>
            <tr>
                <td><code>st.user.sub</code></td>
                <td>str</td>
                <td>Google一意識別子（GoogleID）</td>
            </tr>
        </table>

        <div class="note">
            <div class="note-title">ローカル環境</div>
            <code>st.user.is_logged_in</code> が存在しない場合はローカル環境と判定し、認証をスキップする。
        </div>

        <h3>6.2 ユーザーステータス</h3>
        <p>クラス: <code>UserStatus</code> (<code>auth/user_manager.py</code>)</p>
        <table>
            <tr>
                <th>ステータス</th>
                <th>値</th>
                <th>画面表示</th>
                <th>アプリ利用</th>
            </tr>
            <tr>
                <td>承認待ち</td>
                <td><code>PENDING</code></td>
                <td>承認待ち画面（ステータス確認ボタン）</td>
                <td>不可</td>
            </tr>
            <tr>
                <td>承認済み</td>
                <td><code>APPROVED</code></td>
                <td>メインアプリ</td>
                <td>可能</td>
            </tr>
            <tr>
                <td>却下</td>
                <td><code>REJECTED</code></td>
                <td>却下通知画面</td>
                <td>不可</td>
            </tr>
            <tr>
                <td>BAN</td>
                <td><code>BANNED</code></td>
                <td>アカウント停止画面（BAN理由表示）</td>
                <td>不可</td>
            </tr>
        </table>

        <h3>6.3 認証フロー</h3>
        <div class="step-container">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>ログインチェック</h4>
                    <p><code>st.user.is_logged_in</code> を確認。未ログインならログインページを表示。</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>ユーザー検索</h4>
                    <p><code>st.user.sub</code>（GoogleID）でLark Baseを検索。未登録なら登録フォームを表示。</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>ステータス判定</h4>
                    <p>APPROVED以外は該当する画面を表示して<code>st.stop()</code>。APPROVEDのみアプリ利用可能。</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h4>ログイン記録更新</h4>
                    <p><code>最終ログイン</code>タイムスタンプと<code>ログイン回数</code>をインクリメント。</p>
                </div>
            </div>
        </div>

        <h3>6.4 ユーザーデータ構造（Lark Base）</h3>
        <table>
            <tr>
                <th>フィールド</th>
                <th>型</th>
                <th>説明</th>
            </tr>
            <tr>
                <td><code>GoogleID</code></td>
                <td>文字列</td>
                <td>Google一意識別子</td>
            </tr>
            <tr>
                <td><code>メールアドレス</code></td>
                <td>文字列</td>
                <td>Googleメールアドレス</td>
            </tr>
            <tr>
                <td><code>本名</code></td>
                <td>文字列</td>
                <td>ユーザーの本名（管理者のみ閲覧可）</td>
            </tr>
            <tr>
                <td><code>ニックネーム</code></td>
                <td>文字列</td>
                <td>アプリ内表示名</td>
            </tr>
            <tr>
                <td><code>ステータス</code></td>
                <td>文字列</td>
                <td>承認待ち / 承認済み / 却下 / BAN</td>
            </tr>
            <tr>
                <td><code>管理者</code></td>
                <td>真偽値</td>
                <td>管理者フラグ</td>
            </tr>
            <tr>
                <td><code>登録日時</code></td>
                <td>ISO日時</td>
                <td>初回登録日時</td>
            </tr>
            <tr>
                <td><code>最終ログイン</code></td>
                <td>ISO日時</td>
                <td>最終ログイン日時</td>
            </tr>
            <tr>
                <td><code>ログイン回数</code></td>
                <td>整数</td>
                <td>累計ログイン回数</td>
            </tr>
            <tr>
                <td><code>BAN理由</code></td>
                <td>文字列</td>
                <td>BAN時の理由（BANステータス時のみ）</td>
            </tr>
        </table>

        <h3>6.5 管理者パネル</h3>
        <p>モジュール: <code>admin/admin_panel.py</code></p>
        <p>管理者メールアドレスは <code>st.secrets["admin"]["emails"]</code> で設定。新規登録時に管理者メールの場合は自動承認。</p>

        <table>
            <tr>
                <th>タブ</th>
                <th>表示内容</th>
                <th>操作</th>
            </tr>
            <tr>
                <td><strong>承認待ち</strong></td>
                <td>氏名、メール、申請日</td>
                <td>承認 / 却下</td>
            </tr>
            <tr>
                <td><strong>承認済み</strong></td>
                <td>氏名（管理者バッジ）、メール、登録日、最終ログイン、ログイン回数</td>
                <td>BAN（理由入力）/ 管理者昇格・降格</td>
            </tr>
            <tr>
                <td><strong>BAN・却下</strong></td>
                <td>ステータスバッジ、氏名、メール、理由</td>
                <td>BAN解除 / 承認</td>
            </tr>
        </table>

        <!-- ============================================ -->
        <!-- 7. ファイル形式 -->
        <!-- ============================================ -->
        <h2>7. ファイル形式</h2>

        <h3>7.1 入力ファイル</h3>
        <table>
            <tr>
                <th>カテゴリ</th>
                <th>形式</th>
                <th>使用場面</th>
            </tr>
            <tr>
                <td><strong>動画</strong></td>
                <td>MP4, MOV, AVI, MKV, WebM</td>
                <td>動画から生成</td>
            </tr>
            <tr>
                <td><strong>音声</strong></td>
                <td>WAV, MP3, M4A, AAC, OGG</td>
                <td>音声アップロード</td>
            </tr>
            <tr>
                <td><strong>テキスト</strong></td>
                <td>TXT (UTF-8)</td>
                <td>ファイルから生成</td>
            </tr>
        </table>

        <h3>7.2 出力ファイル</h3>
        <table>
            <tr>
                <th>ファイル</th>
                <th>形式</th>
                <th>説明</th>
            </tr>
            <tr>
                <td><code>{filename}.mov</code></td>
                <td>MOV (ProRes 4444)</td>
                <td>透過動画（アルファチャンネル付き）。Premiere Pro等で合成用</td>
            </tr>
            <tr>
                <td><code>{filename}.txt</code></td>
                <td>TEXT (UTF-8)</td>
                <td>整形済みテキスト（1行14文字以内、句読点付き）</td>
            </tr>
            <tr>
                <td><code>{filename}_full.txt</code></td>
                <td>TEXT (UTF-8)</td>
                <td>整形テキスト + SNSコンテンツ（タイトル・紹介文・ハッシュタグ）</td>
            </tr>
        </table>

        <!-- ============================================ -->
        <!-- 8. 設定パラメータ -->
        <!-- ============================================ -->
        <h2>8. 設定パラメータ</h2>

        <h3>8.1 環境変数（.env）</h3>
        <p>ローカル実行時に <code>.env</code> ファイルで設定。<code>python-dotenv</code> で読み込み。</p>
        <table>
            <tr>
                <th>変数名</th>
                <th>必須</th>
                <th>説明</th>
                <th>デフォルト</th>
            </tr>
            <tr>
                <td><code>GLADIA_API_KEY</code></td>
                <td><span class="badge badge-optional">任意</span></td>
                <td>Gladia API キー（文字起こし機能使用時に必要）</td>
                <td>-</td>
            </tr>
            <tr>
                <td><code>GEMINI_API_KEY</code></td>
                <td><span class="badge badge-optional">任意</span></td>
                <td>Gemini API キー（テキスト整形・SNS生成時に必要）</td>
                <td>-</td>
            </tr>
            <tr>
                <td><code>VOICEVOX_API_URL</code></td>
                <td><span class="badge badge-optional">任意</span></td>
                <td>VOICEVOX APIのURL</td>
                <td><code>http://localhost:50021</code></td>
            </tr>
        </table>

        <div class="note">
            <div class="note-title">Web版の場合</div>
            APIキーはUIの入力フォームから設定する。ブラウザを閉じるとセッションとともに消去される。
        </div>

        <h3>8.2 Streamlit Secrets（secrets.toml）</h3>
        <p>Streamlit Cloud デプロイ時に <code>.streamlit/secrets.toml</code> で設定。</p>

        <div class="code-block"><span class="comment"># .streamlit/secrets.toml</span>

[lark]
app_id = <span class="string">"cli_xxxxxxxxxxxx"</span>
app_secret = <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxx"</span>
base_app_token = <span class="string">"xxxxxxxxxxxxxxxx"</span>
table_id = <span class="string">"tblxxxxxxxxxxxxxxxx"</span>

[admin]
emails = [<span class="string">"admin1@example.com"</span>, <span class="string">"admin2@example.com"</span>]</div>

        <table>
            <tr>
                <th>セクション</th>
                <th>キー</th>
                <th>説明</th>
            </tr>
            <tr>
                <td rowspan="4"><code>[lark]</code></td>
                <td><code>app_id</code></td>
                <td>Lark Suite アプリID</td>
            </tr>
            <tr>
                <td><code>app_secret</code></td>
                <td>Lark Suite アプリシークレット</td>
            </tr>
            <tr>
                <td><code>base_app_token</code></td>
                <td>Lark Base アプリトークン</td>
            </tr>
            <tr>
                <td><code>table_id</code></td>
                <td>Lark Base テーブルID</td>
            </tr>
            <tr>
                <td><code>[admin]</code></td>
                <td><code>emails</code></td>
                <td>管理者メールアドレスのリスト</td>
            </tr>
        </table>

        <h3>8.3 Streamlit設定（config.toml）</h3>
        <div class="code-block"><span class="comment"># .streamlit/config.toml</span>

[server]
maxUploadSize = <span class="string">500</span>        <span class="comment"># アップロード上限 (MB)</span>
maxMessageSize = <span class="string">500</span>       <span class="comment"># メッセージ上限 (MB)</span></div>

        <!-- ============================================ -->
        <!-- 9. ファイル構成 -->
        <!-- ============================================ -->
        <h2>9. ファイル構成</h2>

        <div class="dir-tree">
<span class="folder">TikTok-Re-Editor-FFmpeg-v3-Audio-Upload/</span>
├── <span class="file">app.py</span>                      <span class="desc"># メインStreamlitアプリ (エントリーポイント)</span>
├── <span class="file">requirements.txt</span>             <span class="desc"># Python依存パッケージ</span>
├── <span class="file">.env</span>                         <span class="desc"># 環境変数（ローカル用）</span>
├── <span class="file">README.html</span>                  <span class="desc"># ユーザー向けHTMLマニュアル</span>
├── <span class="file">README.md</span>                    <span class="desc"># 開発者向けMarkdownドキュメント</span>
├── <span class="file">SPEC.html</span>                    <span class="desc"># 技術仕様書（本ドキュメント）</span>
│
├── <span class="file">install.bat</span>                  <span class="desc"># Windowsインストーラー</span>
├── <span class="file">install.command</span>              <span class="desc"># macOSインストーラー</span>
├── <span class="file">start.bat</span>                    <span class="desc"># Windows起動スクリプト</span>
├── <span class="file">start.command</span>                <span class="desc"># macOS起動スクリプト</span>
│
├── <span class="folder">auth/</span>                        <span class="desc"># 認証・ユーザー管理モジュール</span>
│   ├── <span class="file">__init__.py</span>              <span class="desc"># エクスポート定義</span>
│   ├── <span class="file">auth_ui.py</span>               <span class="desc"># 認証UI（ログイン・登録・ステータス画面）</span>
│   ├── <span class="file">lark_base.py</span>             <span class="desc"># Lark Base APIクライアント</span>
│   └── <span class="file">user_manager.py</span>          <span class="desc"># ユーザー管理ロジック</span>
│
├── <span class="folder">admin/</span>                       <span class="desc"># 管理者パネルモジュール</span>
│   ├── <span class="file">__init__.py</span>              <span class="desc"># エクスポート定義</span>
│   └── <span class="file">admin_panel.py</span>           <span class="desc"># 管理者パネルUI</span>
│
├── <span class="folder">utils/</span>                       <span class="desc"># ユーティリティモジュール</span>
│   ├── <span class="file">transcription.py</span>         <span class="desc"># Gladia API（文字起こし）</span>
│   ├── <span class="file">text_formatter.py</span>        <span class="desc"># Gemini API（テキスト整形）</span>
│   ├── <span class="file">voicevox.py</span>              <span class="desc"># VOICEVOX API（音声合成）</span>
│   └── <span class="file">video_generator_ffmpeg.py</span> <span class="desc"># 動画生成（FFmpeg + Pillow）</span>
│
├── <span class="folder">fonts/</span>                       <span class="desc"># 同梱フォント</span>
│   └── <span class="file">NotoSansJP-Bold.otf</span>     <span class="desc"># Noto Sans JP Bold（CJK対応）</span>
│
├── <span class="folder">.streamlit/</span>                  <span class="desc"># Streamlit設定</span>
│   ├── <span class="file">config.toml</span>              <span class="desc"># サーバー設定</span>
│   └── <span class="file">secrets.toml</span>             <span class="desc"># シークレット（Lark, admin）</span>
│
├── <span class="folder">deploy/</span>                      <span class="desc"># デプロイ関連</span>
│   ├── <span class="file">nginx.conf</span>               <span class="desc"># Nginx設定</span>
│   ├── <span class="file">streamlit.service</span>        <span class="desc"># systemdサービス定義</span>
│   ├── <span class="file">setup_conoha.sh</span>          <span class="desc"># ConoHa VPSセットアップ</span>
│   └── <span class="file">packages.txt</span>             <span class="desc"># システムパッケージ（Streamlit Cloud）</span>
│
└── <span class="folder">packages.txt</span>                 <span class="desc"># Streamlit Cloud用システムパッケージ</span></div>

        <!-- ============================================ -->
        <!-- 10. 技術スタック -->
        <!-- ============================================ -->
        <h2>10. 技術スタック</h2>

        <h3>10.1 Python依存パッケージ</h3>
        <table>
            <tr>
                <th>パッケージ</th>
                <th>バージョン</th>
                <th>用途</th>
            </tr>
            <tr>
                <td><code>streamlit</code></td>
                <td>&gt;=1.42.0, &lt;2.0.0</td>
                <td>Webフレームワーク（UI + サーバー）</td>
            </tr>
            <tr>
                <td><code>python-dotenv</code></td>
                <td>latest</td>
                <td>環境変数の.envファイル読み込み</td>
            </tr>
            <tr>
                <td><code>requests</code></td>
                <td>&gt;=2.28.0, &lt;3.0.0</td>
                <td>HTTP通信（Gladia, VOICEVOX, Lark API）</td>
            </tr>
            <tr>
                <td><code>google-genai</code></td>
                <td>&gt;=1.47.0, &lt;2.0.0</td>
                <td>Google Gemini API SDK</td>
            </tr>
            <tr>
                <td><code>Pillow</code></td>
                <td>&gt;=10.0.0, &lt;12.0.0</td>
                <td>画像処理（テキスト画像生成、縦書き描画）</td>
            </tr>
            <tr>
                <td><code>Authlib</code></td>
                <td>&gt;=1.3.2, &lt;2.0.0</td>
                <td>OAuth認証ライブラリ</td>
            </tr>
            <tr>
                <td><code>imageio-ffmpeg</code></td>
                <td>&gt;=0.5.1</td>
                <td>FFmpegバイナリの提供（フォールバック用）</td>
            </tr>
        </table>

        <h3>10.2 外部依存</h3>
        <table>
            <tr>
                <th>ソフトウェア</th>
                <th>バージョン</th>
                <th>用途</th>
                <th>インストール方法</th>
            </tr>
            <tr>
                <td><strong>Python</strong></td>
                <td>3.8以上</td>
                <td>ランタイム</td>
                <td>install.bat / install.command で自動</td>
            </tr>
            <tr>
                <td><strong>FFmpeg</strong></td>
                <td>4.x以上推奨</td>
                <td>動画エンコード・結合・音声処理</td>
                <td>install.bat / install.command で自動</td>
            </tr>
            <tr>
                <td><strong>FFprobe</strong></td>
                <td>FFmpeg同梱</td>
                <td>音声ファイルのメタデータ解析</td>
                <td>FFmpegと同時にインストール</td>
            </tr>
            <tr>
                <td><strong>VOICEVOX</strong></td>
                <td>最新版推奨</td>
                <td>音声合成（ローカル版のみ）</td>
                <td>手動インストール</td>
            </tr>
        </table>

        <h3>10.3 FFmpegバイナリ検索順序</h3>
        <p>関数: <code>_find_binary()</code> (<code>video_generator_ffmpeg.py</code>)</p>
        <table>
            <tr>
                <th>優先度</th>
                <th>検索先</th>
                <th>説明</th>
            </tr>
            <tr>
                <td>1</td>
                <td><code>shutil.which()</code></td>
                <td>システムPATH上のバイナリ</td>
            </tr>
            <tr>
                <td>2</td>
                <td><code>/usr/bin/</code>, <code>/usr/local/bin/</code>, <code>/snap/bin/</code></td>
                <td>固定パス（Linux）</td>
            </tr>
            <tr>
                <td>3</td>
                <td><code>imageio-ffmpeg</code> パッケージ</td>
                <td>Pythonパッケージ同梱のFFmpeg</td>
            </tr>
            <tr>
                <td>4</td>
                <td><code>imageio-ffmpeg</code>と同ディレクトリ</td>
                <td>FFprobe用フォールバック</td>
            </tr>
        </table>

        <!-- ============================================ -->
        <!-- 11. エラーハンドリング -->
        <!-- ============================================ -->
        <h2>11. エラーハンドリング</h2>

        <h3>11.1 API別エラー処理</h3>
        <table>
            <tr>
                <th>モジュール</th>
                <th>エラー種別</th>
                <th>処理</th>
                <th>ユーザー向けメッセージ</th>
            </tr>
            <tr>
                <td rowspan="2"><strong>Gladia API</strong></td>
                <td>HTTPエラー</td>
                <td><code>raise_for_status()</code></td>
                <td>「文字起こしに失敗しました」</td>
            </tr>
            <tr>
                <td>ポーリングタイムアウト</td>
                <td>60回 x 3秒（180秒）で打ち切り</td>
                <td>「文字起こしに失敗しました」</td>
            </tr>
            <tr>
                <td rowspan="2"><strong>Gemini API</strong></td>
                <td>429 (Rate Limit)</td>
                <td>次のモデルにフォールバック</td>
                <td>「Gemini APIのクォータを超過しました」</td>
            </tr>
            <tr>
                <td>404 (Model Not Found)</td>
                <td>次のモデルにフォールバック</td>
                <td>（内部リトライ、ユーザー通知なし）</td>
            </tr>
            <tr>
                <td rowspan="2"><strong>VOICEVOX</strong></td>
                <td>接続エラー</td>
                <td>try/except → None返却</td>
                <td>「VOICEVOXに接続できません」</td>
            </tr>
            <tr>
                <td>合成エラー</td>
                <td>try/except → None返却</td>
                <td>「音声生成に失敗しました」</td>
            </tr>
            <tr>
                <td rowspan="2"><strong>FFmpeg</strong></td>
                <td>コマンド失敗</td>
                <td><code>subprocess.run(check=True)</code></td>
                <td>「動画生成エラー: {詳細}」</td>
            </tr>
            <tr>
                <td>バイナリ未検出</td>
                <td>フォールバックチェーンで検索</td>
                <td>（起動時にログ出力）</td>
            </tr>
            <tr>
                <td rowspan="2"><strong>Lark Base</strong></td>
                <td>権限エラー (1254040等)</td>
                <td>空リスト返却</td>
                <td>（管理者パネル: データ取得不可）</td>
            </tr>
            <tr>
                <td>ネットワークエラー</td>
                <td>try/except → 空リスト返却</td>
                <td>（サイレント: ログのみ）</td>
            </tr>
        </table>

        <h3>11.2 フォント関連</h3>
        <table>
            <tr>
                <th>状況</th>
                <th>処理</th>
            </tr>
            <tr>
                <td>同梱フォントが見つからない</td>
                <td>OS標準フォントにフォールバック</td>
            </tr>
            <tr>
                <td>OS標準フォントも見つからない</td>
                <td>PILデフォルトフォント使用（警告ログ出力）</td>
            </tr>
        </table>

        <h3>11.3 一時ファイル管理</h3>
        <p>全モジュールで <code>tempfile.NamedTemporaryFile</code> を使用。処理完了後に <code>os.unlink()</code> と <code>shutil.rmtree()</code> で確実にクリーンアップ。<code>finally</code> ブロックで異常時も削除を保証。</p>

        <!-- ============================================ -->
        <!-- 12. 更新履歴 -->
        <!-- ============================================ -->
        <h2>12. 更新履歴</h2>

        <div class="version-history">
            <div class="version">
                <h4>v3.2 - Audio Upload (2025-01-29)</h4>
                <ul>
                    <li>音声アップロード機能を追加（タブ4: 音声アップロード）</li>
                    <li>外部TTSで生成した音声から動画を生成可能に</li>
                    <li>単語レベルのタイムスタンプで音声と字幕を正確に同期</li>
                    <li>音声アップロード後、自動で文字起こし＆テキスト整形</li>
                    <li><code>create_video_from_timestamped_segments()</code> メソッド追加</li>
                </ul>
            </div>
            <div class="version">
                <h4>v3.1 (2025-01-23)</h4>
                <ul>
                    <li>ひらがな音声を動画生成に再利用（音声の二重生成を廃止）</li>
                    <li>テキスト修正後の動画再生成に対応</li>
                    <li>ひらがな変換の精度向上（余計なスペース・読点を追加しない）</li>
                    <li>縦書き対応文字を追加（=、+、&times;、&divide;、&rarr;など）</li>
                </ul>
            </div>
            <div class="version">
                <h4>v3.0 (2025-01-18)</h4>
                <ul>
                    <li>透過動画生成に対応（ProRes 4444 + アルファチャンネル）</li>
                    <li>iPhone風プレビュー追加（Dynamic Island付きモックアップ）</li>
                    <li>ひらがな変換機能追加（Gemini API）</li>
                    <li>UI改善（TikTokスタイル: シアン/ピンクカラー）</li>
                    <li>Google OAuth + Lark Base ユーザー管理追加</li>
                    <li>管理者パネル追加（ユーザー承認/BAN/管理者権限管理）</li>
                    <li>FFmpegベースの動画生成エンジンに刷新</li>
                </ul>
            </div>
        </div>

        <div class="footer">
            <p>TikTok Re-Editor v3 Technical Specification | MIT License</p>
        </div>
    </div>
</body>
</html>
