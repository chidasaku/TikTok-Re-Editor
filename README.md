# TikTok Re-Editor v3 - Audio Upload

TikTok向けの透過動画を自動生成するWebアプリケーションです。
外部TTSで生成した音声をアップロードし、縦型（1080x1920）の透過動画を作成できます。

---

## Web版を使う（推奨）

**アプリURL**: https://tiktok-re-editor-nlbqc9ggejy5vmr47kzrj8.streamlit.app/

### 必要なもの（APIキー）

| API | 用途 | 取得先 | 無料枠 |
|-----|------|--------|--------|
| **Gladia API** | 文字起こし・タイムスタンプ | https://www.gladia.io/ | 10時間/月 |
| **Gemini API** | テキスト整形・SNS生成 | https://aistudio.google.com/apikey | 無料 |

### 使い方

1. アプリにアクセス
2. 「API設定」を開いてAPIキーを入力
3. テキストを入力または動画から文字起こし
4. 音声ファイル（WAV/MP3等）をアップロード
5. 「GENERATE VIDEO」で動画生成
6. 透過動画（MOV）をダウンロード

---

## このアプリでできること

### 1. テキストから透過動画を自動生成
- テキストを入力するだけで、音声付きの透過動画を自動生成
- 背景が透過なので、Premiere Proなどで好きな背景と合成可能
- TikTokサイズ（1080x1920）に最適化

### 2. AIによる読み間違い防止
- 漢字をひらがなに変換してから音声生成
- VOICEVOXの読み間違いを防止
- 動画には元の漢字テキストを表示、音声はひらがなで正確に発音

### 3. 動画の文字起こしから自動生成
- 既存の動画をアップロードするだけで文字起こし
- 自動でテキスト整形→音声生成→動画作成

### 4. 音声アップロードで字幕付き動画を自動生成（NEW!）
- 音声ファイル（WAV, MP3, M4A等）をアップロード
- Gladia APIで自動文字起こし＆タイムスタンプ取得
- 音声と字幕がピッタリ合った動画を生成
- 自分の声で収録した音声をそのまま使用可能

### 5. SNS投稿用コンテンツも自動生成
- タイトル案、紹介文案、ハッシュタグを自動提案
- そのままSNSに投稿可能

---

## 必要な環境

### ソフトウェア

| ソフトウェア | 用途 | ダウンロード |
|-------------|------|-------------|
| **Python 3.8以上** | アプリ実行 | https://www.python.org/ |
| **FFmpeg** | 動画生成 | https://ffmpeg.org/ |
| **VOICEVOX** | 音声合成 | https://voicevox.hiroshiba.jp/ |

### APIキー

| API | 用途 | 取得先 | 必須 |
|-----|------|--------|------|
| **Gladia API** | 動画の文字起こし | https://www.gladia.io/ | 動画入力時のみ |
| **Gemini API** | ひらがな変換・テキスト整形・SNS生成 | https://aistudio.google.com/apikey | 推奨 |

---

## インストール

### 1. 必要なライブラリをインストール

**Mac:**
`install.command` をダブルクリック

**Windows:**
`install.bat` をダブルクリック

または手動で:
```bash
pip install -r requirements.txt
```

### 2. FFmpegをインストール

**Mac:**
```bash
brew install ffmpeg
```

**Windows:**
1. https://github.com/BtbN/FFmpeg-Builds/releases にアクセス
2. `ffmpeg-master-latest-win64-gpl.zip` をダウンロード
3. ZIPを解凍して `C:\ffmpeg` に配置（フォルダ名を `ffmpeg` に変更）
4. 環境変数PATHに追加:
   - Windowsキー → 「環境変数」と検索 → 「システム環境変数の編集」をクリック
   - 「環境変数」ボタンをクリック
   - 「システム環境変数」の「Path」を選択 → 「編集」をクリック
   - 「新規」をクリック → `C:\ffmpeg\bin` と入力
   - 「OK」を3回クリックして閉じる
5. PCを再起動
6. コマンドプロンプトで `ffmpeg -version` と入力して確認

### 3. VOICEVOXをインストール

1. https://voicevox.hiroshiba.jp/ からダウンロード
2. アプリケーションをインストール

---

## 使い方（詳細手順）

### STEP 1: 準備

1. **VOICEVOXを起動**
   - アプリを開いておくだけでOK
   - https://voicevox.hiroshiba.jp/

2. **アプリを起動**
   - Mac: `start.command` をダブルクリック
   - Windows: `start.bat` をダブルクリック
   - ブラウザで http://localhost:8501 が開きます

3. **APIキーを設定**（初回のみ）
   - 画面上部の「API設定」をクリック
   - Gemini APIキーを入力（ひらがな変換・SNS生成に必要）
   - 動画から文字起こしする場合はGladia APIキーも入力
   - 「APIキーを保存」をクリック

### STEP 2: テキストを入力

4つの方法から選択:

#### 方法A: 動画から文字起こし
1. 「動画から生成」タブを選択
2. 動画ファイルをアップロード
3. 「START」をクリック（Gladia APIが必要）

#### 方法B: テキストファイルから読み込み
1. 「ファイルから生成」タブを選択
2. .txtファイルをアップロード
3. 「START」をクリック

#### 方法C: テキストを直接入力
1. 「テキスト入力」タブを選択
2. テキストを貼り付け（改行で区切る）
3. 「START」をクリック

#### 方法D: 音声アップロード（外部TTS使用時）
1. 「音声アップロード」タブを選択
2. 音声ファイル（WAV, MP3, M4A等）をアップロード
3. 自動で文字起こし＆テキスト整形
4. テキストを確認・編集（すでに整形済みテキストがあればコピペでOK）
5. 「GENERATE VIDEO」で動画生成

**ポイント**: 単語レベルのタイムスタンプで音声と字幕がピッタリ同期します

### STEP 3: ひらがなに変換

1. **左側のテキスト**を確認・編集（動画に表示されるテキスト）
2. **「ひらがなに変換」をクリック**
3. 右側にひらがなテキストが表示される
4. 必要に応じてひらがなを修正

**重要**: ひらがなは音声生成に使用されます。読み方が間違っていたら修正してください。

### STEP 4: 音声を生成

1. **キャラクターを選択**（例: 青山龍星）
2. **スタイルを選択**（例: ノーマル）
3. **「PREVIEW」で試聴**（任意）
4. **話速を調整**（1.0x = 標準）
5. **間の長さを調整**（1.0 = 標準）
6. **「GENERATE AUDIO」をクリック**
7. 音声が生成されたら再生して確認
8. 「DOWNLOAD AUDIO」で音声をダウンロード（任意）

### STEP 5: 動画を生成

1. **「GENERATE VIDEO」をクリック**
2. 進捗バーが100%になるまで待つ
3. iPhone風フレームでプレビューを確認
4. **「DOWNLOAD VIDEO (.mov)」で透過動画をダウンロード**

**ポイント**:
- ダウンロードされるのは透過動画（MOV形式）
- プレビューはチェッカー背景ですが、実際は透過です
- Premiere Proで背景動画と合成できます

### STEP 6: テキストを修正して再生成（任意）

動画生成後にテキストを修正したい場合:

1. **左側のテキストを編集**
2. **「GENERATE VIDEO」を再度クリック**
3. 修正後のテキストで動画が再生成されます

**注意**: 行数を変更した場合は、音声も再生成が必要です。

### STEP 7: SNSコンテンツを生成（任意）

1. **「GENERATE SNS」をクリック**
2. タイトル案・紹介文案・ハッシュタグが生成される
3. 必要に応じて編集
4. **「DOWNLOAD ALL TEXT」で一括ダウンロード**

---

## 主な機能

### 入力ソース（4種類）

| 入力方法 | 説明 | 必要なAPI |
|---------|------|----------|
| **動画から生成** | 動画をアップロードして文字起こし | Gladia + Gemini |
| **ファイルから生成** | テキストファイル(.txt)をアップロード | なし（ひらがな変換にはGemini） |
| **テキスト入力** | 直接テキストを貼り付け | なし（ひらがな変換にはGemini） |
| **音声アップロード** | 外部TTSの音声から動画生成 | Gladia + Gemini |

### テキスト編集

- **自動整形**: 改行ごとに句読点を自動追加
- **ひらがな変換**: 漢字をひらがなに変換（音声合成の読み間違い防止）
- **2カラム表示**: 表示用テキストと音声用ひらがなを並べて編集
- **ファイル名自動生成**: 内容に基づいてファイル名を提案

### 音声合成（VOICEVOX）

- **キャラクター選択**: VOICEVOXの全キャラクターに対応
- **スタイル選択**: 各キャラクターの感情スタイルを選択
- **話速調整**: 0.7x〜1.3x（7段階）
- **間の長さ**: 句読点での間を0.0〜2.0で調整
- **プレビュー**: 生成前にサンプル音声を確認
- **ダウンロード**: WAV形式で音声をダウンロード

### 動画生成

- **透過動画**: ProRes 4444形式（アルファチャンネル対応）
- **TikTokサイズ**: 1080x1920（縦型）
- **縦書きテキスト**: 動画中央に行ごとにテキストを表示
- **プレビュー**: iPhone風フレームでチェッカー背景プレビュー
- **ダウンロード**: MOV形式で透過動画をダウンロード
- **テキスト修正後の再生成**: 表示テキストを修正して再生成可能

### SNSコンテンツ生成

- **タイトル生成**: 動画内容に基づいたタイトルを自動生成
- **紹介文生成**: 投稿用の紹介文を自動生成
- **ハッシュタグ生成**: 関連するハッシュタグを自動提案
- **一括ダウンロード**: テキスト・SNSコンテンツをまとめてダウンロード

---

## 出力ファイル

| ファイル | 形式 | 説明 |
|---------|------|------|
| `ファイル名.txt` | TEXT | 整形済みテキスト |
| `ファイル名.wav` | WAV | 音声ファイル |
| `ファイル名.mov` | MOV (ProRes 4444) | 透過動画 |
| `ファイル名_full.txt` | TEXT | テキスト + SNSコンテンツ |

---

## 動画の使い方（Premiere Pro）

1. 生成したMOVファイルをPremiere Proに読み込み
2. タイムラインに配置
3. 背景動画の上にレイヤーとして重ねる
4. 透過部分から背景が見える

---

## トラブルシューティング

### VOICEVOXに接続できない

- VOICEVOXアプリが起動しているか確認
- デフォルトURL: `http://localhost:50021`

### 音声が生成されない

- VOICEVOXが起動中か確認
- テキストが空でないか確認

### 動画が生成されない

- FFmpegがインストールされているか確認
- `ffmpeg -version` で確認

### 文字起こしが失敗する

- Gladia APIキーが正しいか確認
- 動画に音声が含まれているか確認

### ひらがな変換ができない

- Gemini APIキーが正しいか確認
- API設定で保存されているか確認

### テキスト修正後に動画が変わらない

- 「GENERATE VIDEO」を再度クリックしてください
- 行数を変更した場合は音声も再生成が必要です

---

## ディレクトリ構成

```
TikTok-Re-Editor-FFmpeg-v3/
├── app.py              # メインアプリケーション
├── requirements.txt    # 必要なライブラリ
├── .env               # APIキー（自動生成）
├── .env.example       # APIキーのサンプル
├── README.md          # このファイル
├── README.html        # マニュアル（HTML版）
├── start.command       # Mac用起動スクリプト
├── start.bat           # Windows用起動スクリプト
├── install.command # Mac用インストールスクリプト
├── install.bat     # Windows用インストールスクリプト
└── utils/
    ├── transcription.py          # Gladia文字起こし
    ├── text_formatter.py         # Geminiテキスト整形・ひらがな変換
    ├── voicevox.py               # VOICEVOX音声合成
    └── video_generator_ffmpeg.py # FFmpeg動画生成
```

---

## 技術仕様

| 項目 | 仕様 |
|------|------|
| 動画サイズ | 1080 x 1920 (TikTok縦型) |
| 動画形式 | MOV (ProRes 4444) |
| 透過 | アルファチャンネル対応 |
| 音声形式 | WAV (16bit PCM) |
| フレームレート | 30fps |
| テキスト表示 | 縦書き（中央配置） |

---

## Streamlit Cloudへのデプロイ方法

自分でデプロイしたい場合の手順です。

### 1. GitHubリポジトリを作成

```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git
git push -u origin main
```

### 2. Streamlit Cloudにデプロイ

1. https://streamlit.io/cloud にアクセス
2. GitHubアカウントでログイン
3. 「New app」をクリック
4. リポジトリを選択
5. Branch: `main`, Main file path: `app.py`
6. 「Deploy!」をクリック

### 3. デプロイ完了

- 数分でアプリが公開されます
- URLは `https://YOUR_APP_NAME.streamlit.app/` 形式

### 必要なファイル

| ファイル | 用途 |
|---------|------|
| `app.py` | メインアプリケーション |
| `requirements.txt` | Pythonパッケージ |
| `packages.txt` | システムパッケージ（FFmpeg） |
| `.streamlit/config.toml` | Streamlit設定 |

---

## ライセンス

MIT License

---

## 更新履歴

### v3.2 - Audio Upload (2025-01-29)
- 音声アップロード機能を追加
- 外部TTSで生成した音声から動画を生成可能
- 単語レベルのタイムスタンプで音声と字幕を正確に同期
- 音声アップロード後、自動で文字起こし＆テキスト整形

### v3.1 (2025-01-23)
- ひらがな音声を動画生成に再利用（音声の二重生成を廃止）
- テキスト修正後の動画再生成に対応
- ひらがな変換の精度向上（余計なスペース・読点を追加しない）
- 縦書き対応文字を追加（=、+、×、÷、→など）

### v3.0 (2025-01-18)
- 透過動画生成に対応
- iPhone風プレビュー追加
- ひらがな変換機能追加
- UI改善（TikTokスタイル）
